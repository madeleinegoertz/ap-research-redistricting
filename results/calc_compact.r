# This script calculates compactness measures for the plans generated by
# all the algorithm and the existing plan

library(redist)
library(tidyverse)
load("results/data.RData")
load("results/mcmc.RData")
load("results/smc.RData")
load("results/crsg.RData")

# MCMC
start.time <- Sys.time()
mcmc.compact <-
  redist.compactness(
    shp = df,
    district_membership = mcmc.out$partitions,
    measure = c("PolsbyPopper", "FryerHolden", "EdgesRemoved"),
    population = df$pop, 
    adjacency = adjlist,
    counties = df$COUNTYFP,
    ncores = 4
  )
end.time <- Sys.time()
print(end.time - start.time)
save(mcmc.compact, file = "results/mcmc.compact.RData")

# SMC
start.time <- Sys.time()
smc.compact <-
  redist.compactness(
    shp = df,
    district_membership = smc.out$cdvec,
    measure = c("PolsbyPopper", "FryerHolden", "EdgesRemoved"),
    population = df$pop, 
    adjacency = adjlist,
    counties = df$COUNTYFP,
    ncores = 4
  )
end.time <- Sys.time()
print(end.time - start.time)
save(smc.compact, file = "results/smc.compact.RData")

# CRSG
start.time <- Sys.time()
crsg.compact <-
  redist.compactness(
    shp = df,
    district_membership = crsg.out$partitions,
    measure = c("PolsbyPopper", "FryerHolden", "EdgesRemoved"),
    population = df$pop, 
    adjacency = adjlist,
    counties = df$COUNTYFP,
    ncores = 4
  )
end.time <- Sys.time()
print(end.time - start.time)
save(crsg.compact, file = "results/crsg.compact.RData")

# control
start.time <- Sys.time()
control.compact <-
  redist.compactness(
    shp = df,
    district_membership = df$CON_DIST,
    measure = c("PolsbyPopper", "FryerHolden", "EdgesRemoved"),
    population = df$pop, 
    adjacency = adjlist,
    counties = df$COUNTYFP,
    ncores = 4
  )
end.time <- Sys.time()
print(end.time - start.time)
save(control.compact, file = "results/control.compact.RData")

# table <-
#   mcmc.compact %>%
#     pivot_wider(
#       names_from = nloop,
#       values_from = PolsbyPopper
#     ) %>%y
#   rowwise(districts) %>% 
#   summarise(m = mean(c_across()))
